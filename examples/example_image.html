<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=1">
    <title>A simple example with webarkit-cv</title>
</head>

<body>
    <img src="face_pattern.jpg" id="face" style="display: none;">
    <img src="rotate.jpg" id="rotate" style="display: none;">
    <script src="../dist/webarkitCV.js"></script>
    <script>
        console.log(WebARKitCV);

        const webarkit = new WebARKitCV.WebARKitCV();
        console.log(webarkit);
        var overlayCanvas;
        var oWidth = 375;
        var oHeight = 375;
        createOverlayCanvas();

        webarkit.setWidth(375)
            .setHeight(450)
            .addTrackable("face", "./face_pattern.jpg")
            .loadTrackables()

        const track = webarkit.build();

        if (track.isLoaded) {
            var imgData = imread("rotate");
            webarkit.track(track.trackers, imgData).then((t) => {
                console.log(t);
                var imgElem = document.getElementById("face");
                window.addEventListener("getMatrix", function (e) {
                    console.log(e.detail);
                    transformElem(e.detail.matrix, imgElem);
                    drawCorners(e.detail.corners);
                }
                )
            })
        }
        function setVideoStyle(elem) {
            elem.style.position = "absolute";
            elem.style.top = 0;
            elem.style.left = 0;
        }
        function createOverlayCanvas() {
            overlayCanvas = document.createElement("canvas");
            setVideoStyle(overlayCanvas);
            overlayCanvas.id = "overlay";
            overlayCanvas.width = oWidth;
            overlayCanvas.height = oHeight;
            overlayCanvas.style.zIndex = 1;
            document.body.appendChild(overlayCanvas);
        }

        function clearOverlayCtx() {
            const overlayCtx = overlayCanvas.getContext("2d");
            overlayCtx.clearRect(0, 0, oWidth, oHeight);
        }

        function drawCorners(corners) {
            const overlayCtx = overlayCanvas.getContext("2d");
            clearOverlayCtx();

            overlayCtx.beginPath();
            overlayCtx.strokeStyle = "blue";
            overlayCtx.lineWidth = 3;

            // [x1,y1,x2,y2,x3,y3,x4,y4]
            overlayCtx.moveTo(corners[0], corners[1]);
            overlayCtx.lineTo(corners[2], corners[3]);
            overlayCtx.lineTo(corners[4], corners[5]);
            overlayCtx.lineTo(corners[6], corners[7]);
            overlayCtx.lineTo(corners[0], corners[1]);

            overlayCtx.stroke();
        }

        function transformElem(h, elem) {
            // column major order
            let transform = [h[0], h[3], 0.0, h[6],
            h[1], h[4], 0.0, h[7],
                0.0, 0.0, 1.0, 0.0,
            h[2], h[5], 0.0, h[8]];
            transform = "matrix3d(" + transform.join(",") + ")";
            elem.style["-ms-transform"] = transform;
            elem.style["-webkit-transform"] = transform;
            elem.style["-moz-transform"] = transform;
            elem.style["-o-transform"] = transform;
            elem.style.transform = transform;
            elem.style.display = "block";
        }

        function imread(imageSource) {
            var img = null;
            if (typeof imageSource === "string") {
                img = document.getElementById(imageSource);
            } else {
                img = imageSource;
            }
            var canvas = null;
            var ctx = null;
            var width, height;
            if (img instanceof HTMLImageElement) {
                canvas = document.createElement("canvas");
                width = img.width;
                height = img.height;
                canvas.width = width;
                canvas.height = height;
                ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, width, height);
            } else if (img instanceof HTMLCanvasElement) {
                canvas = img;
                width = canvas.width;
                height = canvas.height;
                ctx = canvas.getContext("2d");
            } else {
                throw new Error("Please input the valid canvas or img id.");
                return;
            }

            return ctx.getImageData(0, 0, canvas.width, canvas.height);
        }


    </script>

</body>

</html>